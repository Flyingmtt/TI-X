## 模型库
### 概述
模型库是系统全部模型的管理中心，包括已经完成发布的模型集合与正在训练的任务集合。
### 新建模型
在模型库列表页面单击【新建模型】，可以开始一个新训练任务的创建，训练完成之后用户可以根据训练结果选择是否将训练结束的任务发布到模型库中。模型库列表中的模型也可以通过点击【重新训练】进行再次迭代训练。新建模型的步骤如下：
#### 第一步：选择模型镜像
输入信息：

- 模型名称：最长60个字符，字母开头，支持 a-z，A-Z，0-9，-，_，且需要以数字或字母结尾
- 选择镜像：

若选择**通用类型镜像**，需要输入的信息如下：

1.镜像文件。需要从页面下拉列表中选择对应的镜像文件，单击任一镜像版本，右侧会显示该通用镜像的配置信息，用户可以根据具体需求进行选择。
![avatar](/pics/选择镜像1.png)

2.模型参数。选择通用类型的镜像还需配置模型参数，在页面下方有模型参数配置富文本框，系统已经给出了相关参数的缺省值，用户可以选择默认值也可以进行自定义修改配置。
> 模型参数范例：
> 
	{
		"classification": {
        "name": "ResNet18",
        "num_of_classes": 5
    }
    "code_list": [
        "TPFIP",
        "TTFBS",
        "TTMUD",
        "TGGS0",
        "TPOTS",
        "TSFAS",
        "TSDFS"
    ]
    }
- classification层级包含了分类模型相关的参数，其中name表示具体使用的神经网络，目前仅支持一种ResNet18，num_of_classes表示分类模型预测的类别数。
- code_list层级是整个算法需要处理的缺陷名称列表，缺陷列表由分类模型预测的code和特殊缺陷code组成（如果需要处理特殊缺陷），且特殊缺陷TSFAS、TSDFS等列在分类缺陷列表最后，如上例参数代码所示。列表中的"TPFIP","TTFBS","TTMUD","TGGS0","TPOTS"5个code为分类模型预测的code类别（对应于num_of_classes=5），"TSFAS"、"TSDFS"为2个特殊缺陷，至于列表的末尾，算法会进行特殊的处理。
- 如果用户勾选训练分割模型，所有code_list中出现的缺陷名对应的图片都会进行分割模型训练。



3.生产环境信息。通用镜像本身不绑定特定的生产环境信息，因此用户需要在此步骤进行此镜像对应的模型的适用生产环境的选择。
![avatar](/pics/选择镜像2.png)

若选择**业务类镜像**，则用户仅需根据生产环境条件筛选出符合条件的镜像文件及其版本。
![avatar](/pics/选择镜像3.png)

镜像信息配置完成后，单击【下一步】，跳转至选择数据路径步骤。

#### 第二步：选择数据路径
此步骤是为当前模型选择训练数据，训练数据由多个数据路径组成，每个数据路径下包含若干数量图片。

- 添加路径入口：
数据路径选择有两个入口：

第一，选择路径所在的数据集，单击【导入路径】进行数据路径的批量导入，导入后的路径在路径列表可以查看。

第二，单击【添加数据路径】，可直接在路径列表新增路径。
![avatar](/pics/选择数据路径.png)

- 路径列表管理：路径列表维护了当前训练任务所绑定的所有训练数据集对应的路径。【状态】表示该数据路径的有效性，若某条数据路径下不存在图片，则状态判断为无效；【数量】表示了该路径下的图片数量，点击显示；【描述】为添加数据路径时自动带出的路径信息，描述了当前路径数据的适用信息。单击【删除】可以删除当前路径。
> 1. 为了保证模型训练的质量，在新建模型时请务必导入模型镜像训练时所有训练数据集的路径；
> 2. 模型重新训练的时候，不可删除新建模型时所绑定的数据路径；
> 3. 若绑定的数据路径下有任一一条状态为无效，则无法进行下一步，因此请确保绑定的数据路径下有实际训练可用的图片数据。
完成数据路径选择后，单击【下一步】，开始进行训练参数配置。
#### 第三步：配置训练参数
- 配置计算资源：计算资源配置在主数据里进行维护，用户可以根据当前模型所需的计算资源进行选择，这里提供两种计算资源配置，如下图所示：

![avatar](/pics/训练参数配置.png)
- 配置训练参数：页面下方显示训练参数配置富文本框，系统已经给出了相关参数的缺省值，用户可以选择默认值也可以进行自定义修改配置。
> 默认参数范例：
> 
    {
    "classification":{
        "base_lr": 0.001,
        "batch_size": 256,
        "max_iter": 40000,
        "weight_decay":0.0001,
        "momentum": 0.9,
        "lr_policy": "poly",
        "power": 0.9,
        "gamma": 0.1
    },
    "segmentation":{
        "base_lr": 0.01,
        "batch_size": 16,
        "max_iter": 100000,
        "weight_decay": 0.0001,
        "momentum": 0.9,
        "lr_policy": "poly",
        "power": 0.9,
        "gamma": 0.1
    } 
    }
- classification层级包含了分类模型相关的训练参数，segmenatation层级包含了分割模型相关的训练参数。
- 训练默认使用随机梯度下降法(SGD):
- base_lr表示基础学习率，
- batch_size表示批尺寸，
- max_iter表示训练的最大迭代次数（按batch而非epoch），
- weight_decay表示正则化权重，
- momentum表示梯度下降更新时的动量。
- lr_policy目前支持的策略有fixed, exp, inv, poly。
- lr_policy, power, gamma的关系详见下述学习率下降说明：

>> fixed: 实际学习率总是 base_lr
> 
>> exp: 实际学习率是 base_lr  gamma ^ iter, iter为当前迭代次数*
> 
>> inv: 实际学习率是 base_lr  (1 + gamma * iter) ^ (- power), iter为当前迭代次数* 
> 
>> poly: 学习率进行多项式误差, 实际学习率是 base_lr  (1 - iter/max_iter) ^ (power), iter为当前迭代次数, max_iter为最大迭代次数* 
> 
- 如果用户勾未选了训练分割模型，segmentation层级下的参数将无效。

    


#### 第四步：添加预处理参数
新建模型时，系统提供三种预处理参数设置。
![avatar](/pics/预处理参数.png)

- 切分比例： 填写训练集与验证集的切分比例，如0.8表示训练集与验证集的比例为0.8。
- 归一化处理：用户可选择是否开启归一化处理，若开启归一化处理，系统在训练任务开始前对训练数据图片进行分辨率合规过滤处理，自动剔除分辨率不符合要求的图片，并归类为“不合规样本”。
- 数据增强：用户可以选择数据增强的方式，我们提供色彩增强、图像缩放、图像翻转 和随机变换四种选项供用户选择。

> 色彩增强：对图片的hsv色彩空间进行变换生成增强图片
> 
> 图像缩放：以一定比例的缩小或者放大图片生成增强图片
> 
> 图像翻转：对图片进行左右翻转生成增强图片
> 
> 随机变换：融合了缩放以及翻转并且以随机的参数进行变换生成增强图片

- 训练分割选择：如果该模型的任务类型为分割分类，在添加预处理参数界面则会有是否开启训练分割的选项。若要同时进行分割和分类训练，则需勾选【开启训练分割】。

训练任务配置完成后，用户可以到【训练任务管理】页面查看训练任务的运行状态。
### 训练任务管理
训练任务管理模块维护了所有模型的训练任务。用户可在训练任务管理首页查看当前系统所有状态的训练任务。每一个训练任务可查看其对应的模型名称、模型版本、任务状态、创建用户、训练时长和进度条信息，对于不同状态的训练任务，用户可以进行任务的终止、启动、监控、删除等操作，训练完成后还可以查看任务评估报告。
#### 训练任务状态说明
训练任务的状态有“等待中、正在训练、训练终止、训练完成、训练失败、已发布”六种状态。

- 等待中：处于“等待中”的任务表示该训练任务正在等待资源分配或调度过程中，处于等待中的任务无法终止。
- 正在训练：处于“正在训练”中的任务表示该任务已处于训练的过程中，此时用户可以选择单击【终止】按钮手动终止训练进程，也可以单击【监控】按钮查看训练任务进程。
- 训练终止：当用户将状态为“正在训练”的任务终止后，训练任务的状态即为“训练终止”。训练终止的任务可单击【启动】再次启动训练，点击启动后，任务状态转变为正在训练或等待中，进度条从0开始延伸。
- 训练完成：当训练任务全部完成后，该任务的进度条显示为100%，且任务状态切换为“训练完成”，单击【模型评估报告】可查看该次训练的评估结果。单击【模型发布】可将该训练完成的模型添加至我的模型库中。
- 训练失败：当训练任务在运行过程中发生异常时，状态会显示为“训练失败”，单击【监控】可在监控页面点击【下载日志】查看运行日志以查看失败原由；训练失败的任务可单击【启动】按钮再次启动任务。
- 已发布：当任务训练完成后，用户可自行决定是否发布该模型。“发布模型”表示将该训练完成的模型添加至我的模型库中，并生成新的模型版本。只有训练完成的任务才可以进行模型发布，且发布成功以后不可再次发布。

![avatar](/pics/训练任务列表.png)
#### 训练任务监控
处于“正在训练”状态的任务可以查看训练进程状态。训练进程状态监控主要分为两部分：预处理环节状态监控和模型训练过程监控。

1. 预处理环节状态监控

预处理状态监控有三个环节：数据归一化处理、数据划分和数据增强。每个预处理环节均可以查看其“状态”和“运行时间”。任一环节处理结束，该环节的状态即为“完成”，归一化处理环节若出现不合规样本，监控页面亦会暴露其不合规样本数量。
![avatar](/pics/监控1.png)
2. 模型训练过程监控

模型训练过程监控主要有两个部分：整体训练时长监控和模型训练过程损失函数监控。模型训练时长监控采用进度条滚动和展示预计训练结束时间的方式，给用户训练进度的直观感受。若本次训练任务的类型为“分割分类”，监控页面会同时显示分割训练损失函数实时变化和分类训练损失函数实时变化，同时伴有两个训练模块的日志下载功能；若本次训练任务的类型为“分类”，监控页面只会显示分类训练损失函数实时变化。

损失函数实时变化图的横坐标为iteration，纵坐标为loss。损失函数的变化表示该训练模型随着迭代次数的增加，模型总体准确率的趋势。
![avatar](/pics/监控2.png)

单击【下载日志】可将训练过程日志下载到本地进行查看。

#### 训练评估报告
训练任务完成后可以查看本次训练任务的评估报告。训练任务的评估报告展示总体验证集样本的准确率、召回率和交并比IoU（带有分割过程的任务类型在模型训练评估报告中会显示交并比IoU值，分类任务不会显示）。同时，训练评估报告还会展示所有不同缺陷类别的准确率、召回率和IoU（带分割任务）。
![avatar](/pics/训练评估报告.png)
#### 模型发布
查看训练评估报告后，可以对本次训练模型的总体性能有总体了解，如果用户想要保留这个模型，并且在我的模型库中统一进行管理，可单击【模型发布】将改论文任务发布至我的模型库。用户可以对模型进行重新训练，题库预测等操作，发布后模型自动生成新的版本。
![avatar](/pics/模型发布.png)
> 关于模型版本迭代的规则

> 模型版本号的格式为X.XX，其中整数位版本号继承模型所绑定的镜像的版本号，例如，模型A新建的时候绑定的模型镜像的版本为v3.0，则训练完成后发布的模型A的版本为v3.01。小数位的版本号由重新训练的迭代次数逐渐增加。例如，模型A，版本v3.01经过重新训练，绑定不同的数据路径，发布后生成的新的版本号为v3.02。

### 模型管理
所有在训练任务管理页面发布成功的模型均会显示在我的模型页面，模型列表展示了模型名称、模型版本、模型类型、修改人和最近修改时间等信息。
![avatar](/pics/模型列表.png)
单击模型名称，可查看该模型的详细情况，包括模型所属的生产环境信息。
![avatar](/pics/模型详情.png)
#### 模型版本管理
模型详情页面单击【版本管理】标签，可查看该模型的历史版本，针对每个历史版本，都可以进行再次训练、题库预测以及导出。
![avatar](/pics/版本管理.png)
#### 模型评估报告
单击模型列表【操作】栏的【模型评估报告】，可查看当前版本模型最新一次题库预测的评估报告。
![avatar](/pics/模型评估报告.png)
模型评估报告展示了题库预测结果的性能指标，总体报告分为左右两个模块：

模块左上半部分展示了模型的总体预测准确率、召回率和IoU（带分割的模型），下半部分展示了题库数据各个缺陷类别的预测准确率、召回率和IoU（带分割的模型）。

模块右展示了每个缺陷类别评估结果的下钻信息，单击左侧缺陷类别栏，右侧展示该类别下的所有误判样本和不合规样本的置信度信息和预测结果信息。每个样本均可放大查看，并且同时支持单个样本的下载和批量打包下载。其中误判样本表示预测结果与真实缺陷类别不一致的样本，不合规样本表示在预测过程预处理阶段筛选出来的不符合图片样本分辨率规格的样本。
#### 重新训练
单击模型列表的【重新训练】，可对该模型发起新的训练任务，用户可以选择不同的训练数据路径，同时也可以对训练参数和预处理参数进行调整，通过迭代训练完成模型的版本升级。
#### 题库预测
单击模型列表的【题库预测】，可对该模型发起新的预测任务，用户可以选择不同的题库数据路径，同时也可以对预测参数和预处理参数进行调整，可以查看当前模型版本的题库预测结果。
#### 模型导出
单击模型列表的【导出】，可以直接导出模型文件包，该模型文件包包括以下三种文件：

- models.xbin
- libCsotArtifact.so
- config.yaml
